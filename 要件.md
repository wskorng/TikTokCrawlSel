# 作りたいもの
tiktok動画の再生数推移のビッグデータ

## プロパティ
右辺はTikTokApiでの属性名
- 必須:
    - URL = url
        - ユーザー情報 = author.uniqueId + author.nickname
        - ID = id
    - タイトル = desc
    - 投稿日時 = createTime (日付だけでも可)
    - 再生数 = stats.playCount の推移
- かなり欲しい
    - いいね数 = stats.diggCount の推移
    - コメント数 = stats.commentCount の推移
    - 共有数 = stats.shareCount の推移
    - 保存数 = stats.collectCount の推移
- どうせなら取っときたい
    動画時間 = duration
    カバー画像 = cover
    音声ID= music.id
    音声タイトル = music.title
    音声アーティスト名 = music.authorName

## 量
- 推移を長くても1日間隔で取得
- 30000動画くらい追いたいかな？

# データの取りかた
## TikTokAPI
- っていうライブラリ
    - video.py
        - 普通にrequestsで動画urlにアクセスして `<script id="SIGI_STATE" type="application/json">`で見つかるjson部分を読んでる
            - ヘッダー指定可能
                - リファラーは https://www.tiktok.com/ 固定っぽい
            - プロキシ指定可能
        - 上記のプロパティ全部読める
- 当然書きやすいしこれで済むなら一番楽
- 結構設定してもすぐbot検知される
    - 諦めよう

## スクレイピング
- ツールはplaywrightとseleniumが考えられるが、seleniumのほうがベースがヘッドレスじゃないしちゃんと動画再生できるのでbot検知にひっかかりづらそう
### どのブラウザ使う？
- pcのchrome
    - 動画ページ
        - あり url
        - あり タイトル
        - あり 投稿日
        - あり いいね数 コメント数 保存数
        - なし！ 再生数
    - 動画ページの「クリエイターの動画」欄
        - 新着順 その動画自体も含む
        - スクロールすれば無限に出てくる
        - あり url
        - あり 再生数
    - ユーザーページ:
        - 新着順
        - スクロールすれば無限に出てくる
        - あり url
        - あり いいね数
- iphoneのsafari
    - 動画ページ
        - あり url
        - あり タイトル
        - あり いいね数 コメント数
    - 動画ページの「クリエイターの動画」欄
        - スクロールすれば無限に出てくる
        - あり url
        - あり いいね数
    - ユーザーページ:
        - スクロールすれば無限に出てくる
        - あり url
        - あり 再生数
        - 長押しすればあり タイトル いいね数 コメント数
    - ただページのリンク押そうとするとapple storeに飛ばしてくる

androidもどうせiphoneのsafariと同じで一生ストアに飛ばしてくるやろな

pcのchromeで人間らしい動きを再現するのどう？

### pcのchromeで人間らしい動きを再現
こう移動して
- ホーム -(フォロー中のアカウントからクリック)-> ユーザーページ0
- ユーザーページi -(フォロー中のアカウントからクリック)-> ユーザーページi+1
- ユーザーページ -(普通にサムネをクリック)-> 動画ページ
- 動画ページ -(クリエイターの動画をクリック)-> 動画ページの「クリエイターの動画」欄
- 動画ページの「クリエイターの動画」欄 -(左上のバツをクリック)-> ユーザーページ

こう収集する
- ユーザーページ: 新着動画のurl
- ユーザーページ: urlといいね数のペア
- 動画ページ: 投稿日とタイトル(新着動画のみ)
- 適当(最新でええやろ)な動画ページの「クリエイターの動画」欄: urlと再生数のペア

reCAPTCHA的なの出たら検知して対応するのも要るわな それか出たら閉じて別のアカウント別のプロキシで再開でもいいけど

## 仮想デスクトップ
「pcのchromeで人間らしい動きを再現」の操作を仮想デスクトップのマクロでやることで無理やり
そんで少し動きランダムにしたら流石に検知されることないやろ
これgoogle cloud platformでできるんか？


# DB構造
これでどうや
movie_desc_raw_data と movie_stat_raw_data を駆使して顧客に見せるデータ整形するのはクローラーとは別のプロセスでやりましょう。

## クロール用アカウント一覧
`crawler_accounts (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    username TEXT NOT NULL,
    password TEXT NOT NULL,
    proxy TEXT,
    is_alive BOOLEAN NOT NULL,
    last_crawled_at DATETIME,
    )`
- クロールアカウントごとにproxy分けたほうが人間のアクセスっぽいよね
- banされたらis_aliveをfalseにして通知出して人間が頑張って別アカウントへの移行するみたいな

## クロール用アカウントがどのアカウントのクロールを担当するか
`favorite_accounts (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    favorite_account_username TEXT NOT NULL, //tiktokのusernameそのまま。
    crawler_account_id INTEGER,
    favorite_account_is_alive BOOLEAN NOT NULL,
    crawl_priority(仮) INT DEFAULT 10,
    last_crawled_at DATETIME,
    )`
- last_crawled_atとcrawl_priority(仮)の兼ね合いで優先度つけてクロールする。
- favorite_account_usernameはユーザーが変更することあるが最新のusernameで。
    - ちゃんとできるかな？以前のusernameのページに入ろうとしたらtiktokが現在のusernameのページに飛ばしてくれるならそれ検知して更新すりゃいい話だけど

## 動画の基本情報の生データ
`movie_desc_raw_data (
    id VARCHAR(255) PRIMARY KEY NOT NULL, //tiktokの動画IDそのまま
    url TEXT,
    account_username TEXT, //tiktokのusernameそのまま。
    account_nickname TEXT,
    title TEXT,
    posted_at_text TEXT, //「3-11」とか「3時間前」とかの表記でしかスクレイピングでは取れない
    posted_at DATETIME, //posted_at_textから読み取ろう
    crawled_at DATETIME NOT NULL,
    )`
- account_usernameはユーザーが変更することあるが最新のusernameで。じゃないと追えなくなるからね。

## 動画の統計情報のクロール時点での生データ
`movie_stat_raw_data (
    id INT AUTO_INCREMENT PRIMARY KEY NOT NULL, //tiktokの動画IDそのまま
    movie_id VARCHAR(255) NOT NULL, //tiktokの動画IDそのまま
    play_count_text TEXT, //「2259」とか「341.1K」とか「1.5M」とかの表記でしかスクレイピングでは取れない
    play_count INTEGER,
    like_count_text TEXT,
    like_count INTEGER,
    crawled_at DATETIME NOT NULL
    )`


# やること
- 「pcのchromeで人間らしい動きを再現」やるしかねえぞ締め切り近いんだ
    - 今できてるのがmysqlなんでmysqlでやろうね
    - 今できてるのがgoogle cloud platformなんだけど知ったこっちゃない とりあえず単なるスクリプトとして作ってスクレピングできるの確認せないかん その後いい感じに移植してよね